<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Films Catalog</title>
    <link rel="stylesheet" th:href="@{/style.css}">
</head>
<body>

<header class="header">
    <div class="container">
        <h1 class="logo">üé¨ Films Catalog</h1>
        <p class="subtitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–ª—å–º–æ–≤</p>
    </div>
</header>

<main class="container">

    <div class="catalog">
        <div class="film-card" th:each="film : ${films}">
            <div class="card-body">
                <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∏–ª—å–º–µ</h3>
                <form th:action="@{/films/update}" method="post" class="edit-film-form">

                    <input type="hidden" name="id" th:value="${film.id}">

                    <input type="text" name="title"
                           th:value="${film.title}"
                           th:attr="data-original=${film.title}"
                           required>

                    <input type="text" name="director"
                           th:value="${film.director}"
                           th:attr="data-original=${film.director}"
                           required>

                    <input type="number" name="year"
                           th:value="${film.releaseYear}"
                           th:attr="data-original=${film.releaseYear}"
                           required>

                    <textarea name="description"
                              th:text="${film.description}"
                              th:attr="data-original=${film.description}"></textarea>

                    <button type="submit" class="btn-primary hidden">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>

                <hr>

                <h4>–ê–∫—Ç–µ—Ä—ã:</h4>
                <ul class="actor-list">
                    <li th:each="fa : ${film.filmActors}">
                        <span th:text="${fa.actor.name} + ' ‚Äî ' + ${fa.roleName}"></span>
                        <form th:action="@{/films/removeActor}" method="post" style="display:inline">
                            <input type="hidden" name="filmActorId" th:value="${fa.id}">
                            <button class="btn-small" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                        </form>
                    </li>
                </ul>

                <form th:action="@{/films/delete}" method="post" style="margin-top:10px;">
                    <input type="hidden" name="id" th:value="${film.id}">
                    <button class="btn-danger" type="submit">–£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º</button>
                </form>

            </div>
        </div>
    </div>


    <div class="film-card">
        <h2>–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</h2>
        <form th:action="@{/films/add}" method="post" id="filmForm">

            <input name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required><br>
            <input name="director" placeholder="–†–µ–∂–∏—Å—Å—ë—Ä" required><br>
            <input name="year" type="number" placeholder="–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞" required><br>
            <textarea name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea><br>

            <h3>–ê–∫—Ç–µ—Ä—ã —Ñ–∏–ª—å–º–∞</h3>
            <div id="newActorsContainer">

            </div>
            <button type="button" class="btn-small" id="addActorBtn">–î–æ–±–∞–≤–∏—Ç—å –∞–∫—Ç–µ—Ä–∞</button><br><br>

            <button type="submit" class="btn-primary">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∏–ª—å–º</button>
        </form>
    </div>

    <div style="text-align:center; margin: 40px 0;">
        <a th:href="@{/actors}" class="btn-primary">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–µ—Ä–∞–º–∏</a>
        <a th:href="@{/}" class="btn-primary">–ö–∞—Ç–∞–ª–æ–≥ —Ñ–∏–ª—å–º–æ–≤</a>
    </div>

</main>

<footer class="footer">
    <p>¬© 2026 Eremkin Films Demo</p>
</footer>

<script th:inline="javascript">
    /*<![CDATA[*/
    window.actors = JSON.parse(/*[[${actorsJson}]]*/ '[]');
    /*]]>*/
    console.log(window.actors);
    window.actors.forEach(a => console.log(a.name));
    /*<![CDATA[*/

    function addActorRow() {
        const container = document.getElementById("newActorsContainer");

        const actorBlock = document.createElement("div");
        actorBlock.className = "add-actor-block";

        const actorSelect = document.createElement("select");
        actorSelect.name = "actorIds";
        actorSelect.required = true;

        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "--–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫—Ç–µ—Ä–∞--";
        actorSelect.appendChild(defaultOption);

        window.actors.forEach(a => {
            const opt = document.createElement("option");
            opt.value = a.id;
            opt.textContent = a.name;
            actorSelect.appendChild(opt);
        });

        const roleInput = document.createElement("input");
        roleInput.name = "roleNames";
        roleInput.placeholder = "–†–æ–ª—å";
        roleInput.required = true;

        const removeBtn = document.createElement("button");
        removeBtn.type = "button";
        removeBtn.className = "btn-small";
        removeBtn.textContent = "–£–¥–∞–ª–∏—Ç—å";
        removeBtn.onclick = () => actorBlock.remove();

        actorBlock.appendChild(actorSelect);
        actorBlock.appendChild(roleInput);
        actorBlock.appendChild(removeBtn);

        container.appendChild(actorBlock);
    }

    document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("addActorBtn").addEventListener("click", addActorRow);
    });
    document.addEventListener("DOMContentLoaded", function () {

        document.querySelectorAll(".edit-film-form").forEach(form => {

            const inputs = form.querySelectorAll("input[name='title'], input[name='director'], input[name='year'], textarea[name='description']");
            const saveBtn = form.querySelector(".btn-primary");

            function checkChanges() {
                let changed = false;

                inputs.forEach(input => {
                    if (input.value !== input.dataset.original) {
                        changed = true;
                    }
                });

                if (changed) {
                    saveBtn.classList.remove("hidden");
                } else {
                    saveBtn.classList.add("hidden");
                }
            }

            inputs.forEach(input => {
                input.addEventListener("input", checkChanges);
            });

        });

    });
    /*]]>*/
</script>

</body>
</html>
